<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transformer Phase Shift (Field Method) | Super Tools</title>
  <meta name="description" content="Calculate transformer phase shift using only RMS voltage measurements (field method)." />

  <link rel="stylesheet" href="../styles.css" />

  <!-- If you already load MathJax globally in your layout, you can remove this block -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(', '\\)'], ['$', '$']] },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- Optional: your include-layout system (if you use it on other pages) -->
  <script defer src="../include-layout.js"></script>

  <style>
    /* Small page-specific tweaks (safe even if you already have styles.css) */
    .tool-grid { display: grid; gap: 14px; }
    .tool-grid .row { display: grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .tool-grid .row { grid-template-columns: 1fr 1fr; } }
    .field { display: grid; gap: 6px; }
    .field label { font-weight: 600; }
    .field input, .field select { padding: 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,.15); }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 8px; }
    .result-box { padding: 14px; border-radius: 14px; border: 1px solid rgba(0,0,0,.12); background: rgba(0,0,0,.02); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { opacity: .8; }
    details { margin-top: 12px; }
    summary { cursor: pointer; font-weight: 700; }
    .warn { padding: 10px 12px; border-radius: 12px; background: rgba(255, 196, 0, .15); border: 1px solid rgba(255, 196, 0, .35); }
    .err  { padding: 10px 12px; border-radius: 12px; background: rgba(255, 0, 0, .08); border: 1px solid rgba(255, 0, 0, .20); }
  </style>
</head>

<body>
  <!-- If include-layout.js injects header/footer automatically, keep body clean -->
  <main class="wrap" style="padding: 22px 0 40px;">
    <h1>Transformer Phase Shift (Field Method)</h1>
    <p class="muted">
      This tool calculates the <strong>phase shift (φ)</strong> introduced by an industrial step-up transformer using only
      <strong>RMS voltage measurements</strong> performed on site with a standard voltmeter.
    </p>

    <section class="tool-grid" aria-label="Tool inputs and calculation">
      <div class="row">
        <div class="field">
          <label for="vllBefore">Line-to-Line Voltage before Transformer (RMS) — V<sub>LL,before</sub> [V]</label>
          <input id="vllBefore" type="number" inputmode="decimal" step="any" placeholder="e.g., 110" />
        </div>

        <div class="field">
          <label for="vllAfter">Line-to-Line Voltage after Transformer (RMS) — V<sub>LL,after</sub> [V]</label>
          <input id="vllAfter" type="number" inputmode="decimal" step="any" placeholder="e.g., 110" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="vl1l1">Same Phase (L1-L1) before vs after (RMS) — V<sub>L1,L1</sub> [V]</label>
          <input id="vl1l1" type="number" inputmode="decimal" step="any" placeholder="e.g., 0 / 30 / ..." />
        </div>

        <div class="field">
          <label for="unit">Output unit</label>
          <select id="unit">
            <option value="deg" selected>Degrees (°)</option>
            <option value="rad">Radians (rad)</option>
            <option value="both">Both</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnCalc" type="button">Calculate Phase Shift</button>
        <button class="btn secondary" id="btnClear" type="button">Clear</button>
      </div>

      <div id="msg" class="warn" style="display:none;"></div>
      <div id="_knownIssue" class="err" style="display:none;"></div>

      <div class="result-box" aria-live="polite">
        <div class="muted">Result</div>
        <div id="out" style="font-size: 1.25rem; font-weight: 800; margin-top: 6px;">—</div>
        <div id="out2" class="muted" style="margin-top: 6px;"></div>
        <div id="debug" class="mono muted" style="margin-top: 10px;"></div>
      </div>
    </section>

    <details>
      <summary>Method explanation (derivation)</summary>

      <section style="margin-top: 10px;">
        <h2 style="font-size: 1.05rem;">Purpose</h2>
        <p>
          This method determines the transformer phase shift by exploiting the fact that the
          difference of two sinusoidal voltages of equal frequency but different phase angles is still a sinusoid,
          and its RMS value depends on \( \cos(\varphi) \).
        </p>

        <h2 style="font-size: 1.05rem;">Required inputs</h2>
        <ul>
          <li>\(V_{LL,before}\): Line-to-line RMS voltage measured before the transformer</li>
          <li>\(V_{LL,after}\): Line-to-line RMS voltage measured after the transformer</li>
          <li>\(V_{L1,L1}\): RMS voltage measured between the same phase (L1) before and after the transformer</li>
        </ul>

        <h2 style="font-size: 1.05rem;">From line-to-line to phase</h2>
        <p>
          For a balanced three-phase system:
          \[
            V_{phase} = \frac{V_{LL}}{\sqrt{3}}
          \]
          and the peak of the phase voltage is:
          \[
            V_{phase,peak} = V_{LL}\cdot\frac{\sqrt{2}}{\sqrt{3}}
          \]
        </p>

        <h2 style="font-size: 1.05rem;">Instantaneous phase voltages</h2>
        <p><strong>Before the transformer:</strong></p>
        \[
          f_1(t) =
          V_{LL,before}\cdot\frac{\sqrt{2}}{\sqrt{3}}
          \cdot
          \sin(2\pi f t)
        \]
        <p><strong>After the transformer (including phase shift \( \varphi \)):</strong></p>
        \[
          f_2(t) =
          V_{LL,after}\cdot\frac{\sqrt{2}}{\sqrt{3}}
          \cdot
          \sin(2\pi f t - \varphi)
        \]

        <h2 style="font-size: 1.05rem;">Voltage difference and RMS</h2>
        <p>
          The measured same-phase voltage corresponds to the RMS of:
          \[
            f(t) = f_1(t) - f_2(t)
          \]
          Using the RMS definition over one period \(T\):
          \[
            f_{RMS} =
            \sqrt{
              \frac{1}{T}
              \int_{0}^{T}
              [f(t)]^2 \, dt
            }
          \]
          This simplifies to:
          \[
            f_{RMS}^2 =
            \frac{1}{3}
            \left(
              V_{LL,before}^2
              +
              V_{LL,after}^2
              -
              2\,V_{LL,before}\,V_{LL,after}\cos\varphi
            \right)
          \]
        </p>

        <h2 style="font-size: 1.05rem;">Link with the measured value</h2>
        <p>
          Since \(f_{RMS} = V_{L1,L1}\), we obtain:
          \[
            3\,V_{L1,L1}^2 =
            V_{LL,before}^2
            +
            V_{LL,after}^2
            -
            2\,V_{LL,before}\,V_{LL,after}\cos\varphi
          \]
          Solving for \(\cos\varphi\):
          \[
            \cos\varphi =
            \frac{
              3\,V_{L1,L1}^2
              -
              V_{LL,after}^2
              -
              V_{LL,before}^2
            }{
              2\,V_{LL,after}\,V_{LL,before}
            }
          \]
          and therefore:
          \[
            \varphi =
            \arccos
            \left(
              \frac{
                3\,V_{L1,L1}^2
                -
                V_{LL,after}^2
                -
                V_{LL,before}^2
              }{
                2\,V_{LL,after}\,V_{LL,before}
              }
            \right)
          \]
        </p>
      </section>
    </details>

  </main>

  <script>
    function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }

    function formatNumber(x, digits = 4) {
      if (!isFinite(x)) return "—";
      return Number(x).toLocaleString(undefined, { maximumFractionDigits: digits });
    }

    function show(el, on, text) {
      el.style.display = on ? "block" : "none";
      if (text !== undefined) el.textContent = text;
    }

    function computePhi(vllB, vllA, vl1l1) {
      // cos(phi) = (3*Vl1l1^2 - VllA^2 - VllB^2) / (2*VllA*VllB)
      const num = 3 * vl1l1 * vl1l1 - vllA * vllA - vllB * vllB;
      const den = 2 * vllA * vllB;
      const c = num / den;
      return { cosphi_raw: c, cosphi: clamp(c, -1, 1), phi_rad: Math.acos(clamp(c, -1, 1)) };
    }

    function validateFeasibility(vllB, vllA, vl1l1) {
      // From: 3*Vl1l1^2 = VllB^2 + VllA^2 - 2*VllB*VllA*cos(phi)
      // cos(phi) in [-1,1] implies:
      // (VllB - VllA)^2 <= 3*Vl1l1^2 <= (VllB + VllA)^2
      const left = (vllB - vllA) * (vllB - vllA);
      const mid  = 3 * vl1l1 * vl1l1;
      const right= (vllB + vllA) * (vllB + vllA);
      return { ok: (mid >= left - 1e-9) && (mid <= right + 1e-9), left, mid, right };
    }

    const vllBefore = document.getElementById("vllBefore");
    const vllAfter  = document.getElementById("vllAfter");
    const vl1l1     = document.getElementById("vl1l1");
    const unit      = document.getElementById("unit");
    const out       = document.getElementById("out");
    const out2      = document.getElementById("out2");
    const debug     = document.getElementById("debug");
    const msg       = document.getElementById("msg");
    const knownIssue= document.getElementById("_knownIssue");

    document.getElementById("btnClear").addEventListener("click", () => {
      vllBefore.value = "";
      vllAfter.value  = "";
      vl1l1.value     = "";
      out.textContent = "—";
      out2.textContent = "";
      debug.textContent = "";
      show(msg, false);
      show(knownIssue, false);
    });

    document.getElementById("btnCalc").addEventListener("click", () => {
      show(msg, false);
      show(knownIssue, false);

      const vB = Number(vllBefore.value);
      const vA = Number(vllAfter.value);
      const vP = Number(vl1l1.value);

      if (!(vB > 0) || !(vA > 0) || !(vP >= 0)) {
        show(knownIssue, true, "Please enter valid RMS voltages: VLL_before > 0, VLL_after > 0, and VL1L1 ≥ 0.");
        return;
      }

      const feas = validateFeasibility(vB, vA, vP);
      if (!feas.ok) {
        show(msg, true,
          "Warning: the input set is not physically consistent with any real phase shift. " +
          "Please re-check the measurements (wiring, meter range, steady-state)."
        );
      }

      const r = computePhi(vB, vA, vP);

      const phiDeg = r.phi_rad * (180 / Math.PI);
      const phiRad = r.phi_rad;

      const mode = unit.value;
      if (mode === "deg") {
        out.textContent = `${formatNumber(phiDeg, 3)} °`;
        out2.textContent = `(${formatNumber(phiRad, 6)} rad)`;
      } else if (mode === "rad") {
        out.textContent = `${formatNumber(phiRad, 6)} rad`;
        out2.textContent = `(${formatNumber(phiDeg, 3)} °)`;
      } else {
        out.textContent = `${formatNumber(phiDeg, 3)} °`;
        out2.textContent = `${formatNumber(phiRad, 6)} rad`;
      }

      debug.textContent =
        `cos(phi) raw = ${formatNumber(r.cosphi_raw, 8)} | clamped = ${formatNumber(r.cosphi, 8)}\n` +
        `Feasibility check: (Vb - Va)^2 = ${formatNumber(feas.left, 4)} | 3*Vp^2 = ${formatNumber(feas.mid, 4)} | (Vb + Va)^2 = ${formatNumber(feas.right, 4)}`;

      // Re-render MathJax if present (optional)
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
    });
  </script>
</body>
</html>

