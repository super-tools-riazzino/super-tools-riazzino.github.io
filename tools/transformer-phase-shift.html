<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phase shift (Δφ) | Super Tools</title>
  <meta name="description" content="Calculate transformer phase shift using RMS voltage measurements (field method)." />

  <!-- Shared stylesheet (same pattern as index.html) -->
  <link rel="stylesheet" href="../css/styles.css" />
  <script defer src="/js/site.js"></script>

  <!-- Page-specific minimal tweaks (kept small) -->
  <style>
    .tool-grid { display: grid; gap: 14px; margin-top: 14px; }
    .tool-grid .row { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 820px) { .tool-grid .row { grid-template-columns: 1fr 1fr; } }

    .field { display: grid; gap: 6px; }
    .field label { font-weight: 700; }
    .field input, .field select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.15);
      background: #fff;
    }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 4px; }

    .result-box {
      margin-top: 10px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.02);
    }
    .muted { opacity: .85; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .warn {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 196, 0, .16);
      border: 1px solid rgba(255, 196, 0, .38);
    }
    .err {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 0, 0, .08);
      border: 1px solid rgba(255, 0, 0, .22);
    }

    details { margin-top: 14px; }
    summary { cursor: pointer; font-weight: 800; }
    .eq { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.1); background: #fff; }
  </style>
</head>

<body>
  <!-- same pattern as index.html -->
  <div id="site-header"></div>

  <section class="hero">
    <div class="wrap">
      <div class="tag">Electrical</div>
      <h1>Phase shift (Δφ) — Transformer (Field Method)</h1>
      <p>
        Calculate transformer phase shift using <strong>only RMS voltage measurements</strong>
        (typical on-site “field method” with a standard voltmeter).
      </p>

      <div class="note">
        Inputs required: <strong>VLL before</strong>, <strong>VLL after</strong>, and <strong>VL1-L1 (same phase)</strong>.
      </div>
    </div>
  </section>

  <main class="wrap" style="padding-top: 18px; padding-bottom: 42px;">
    <div class="section-title">Tool</div>

    <section class="tool-grid" aria-label="Inputs and calculation">
      <div class="row">
        <div class="field">
          <label for="vllBefore">Line-to-Line RMS before transformer — V<sub>LL,before</sub> [V]</label>
          <input id="vllBefore" type="number" inputmode="decimal" step="any" placeholder="e.g., 100 / 110" />
        </div>

        <div class="field">
          <label for="vllAfter">Line-to-Line RMS after transformer — V<sub>LL,after</sub> [V]</label>
          <input id="vllAfter" type="number" inputmode="decimal" step="any" placeholder="e.g., 100 / 110" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="vl1l1">Same phase RMS (L1 before vs L1 after) — V<sub>L1,L1</sub> [V]</label>
          <input id="vl1l1" type="number" inputmode="decimal" step="any" placeholder="e.g., 0 / 30 / 110 ..." />
        </div>

        <div class="field">
          <label for="unit">Output</label>
          <select id="unit">
            <option value="deg" selected>Degrees (°)</option>
            <option value="rad">Radians (rad)</option>
            <option value="both">Both</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnCalc" type="button">Calculate Δφ →</button>
        <button class="btn secondary" id="btnClear" type="button">Clear</button>
      </div>

      <div id="msgWarn" class="warn" style="display:none;"></div>
      <div id="msgErr" class="err" style="display:none;"></div>

      <div class="result-box" aria-live="polite">
        <div class="muted">Result</div>
        <div id="outMain" style="font-size: 1.25rem; font-weight: 900; margin-top: 6px;">—</div>
        <div id="outAlt" class="muted" style="margin-top: 6px;"></div>

        <div id="debug" class="mono muted" style="margin-top: 10px;"></div>
      </div>
    </section>

      <details>
        <summary>Method explanation (derivation)</summary>
        <div style="margin-top: 12px;">
          <p class="muted">
            The idea is simple: we want to estimate the phase shift <strong>φ</strong> using only three RMS measurements:
            <strong>V<sub>LL,before</sub></strong>, <strong>V<sub>LL,after</sub></strong>, and <strong>V<sub>L1,L1</sub></strong>.
            <br>
            <strong>V<sub>L1,L1</sub></strong> is measured between <strong>L1 (before transformer)</strong> and
            <strong>L1 (after transformer)</strong>, i.e. the same phase on both sides.
          </p>
      
          <p class="muted">
            Since the voltmeter gives RMS values, we rebuild the corresponding <strong>sinusoidal waveforms</strong>
            (balanced 3-phase assumption, so <strong>V<sub>phase</sub> = V<sub>LL</sub>/√3</strong>).
          </p>
      
          <div class="eq">
            <div style="font-weight: 800;">1) Rebuild the two sinusoids</div>
            <div class="mono" style="margin-top: 8px;">
              f<sub>1</sub>(t) = V<sub>LL,before</sub> · √2 · sin(2πft) / √3
            </div>
            <div class="mono" style="margin-top: 10px;">
              f<sub>2</sub>(t) = V<sub>LL,after</sub> · √2 · sin(2πft − φ) / √3
            </div>
            <div class="muted" style="margin-top: 10px;">
              Note: φ is introduced here as an unknown variable and will be solved from the RMS relationship.
            </div>
          </div>
      
          <div class="eq" style="margin-top: 12px;">
            <div style="font-weight: 800;">2) Take the difference and compute its RMS</div>
            <div class="mono" style="margin-top: 8px;">
              f<sub>3</sub>(t) = f<sub>1</sub>(t) − f<sub>2</sub>(t)
            </div>
            <div class="muted" style="margin-top: 10px;">
              The key observation is that the RMS of this difference must match the measured same-phase voltage:
              <strong>RMS(f<sub>3</sub>) = V<sub>L1,L1</sub></strong>.
            </div>
          </div>
      
          <div class="eq" style="margin-top: 12px;">
            <div style="font-weight: 800;">3) Solve the RMS equation for φ</div>
            <div class="muted" style="margin-top: 8px;">
              For two same-frequency sinusoids, the RMS of the difference depends on <strong>cos(φ)</strong>. After simplification:
            </div>
      
            <div class="mono" style="margin-top: 10px;">
              3 · V<sub>L1,L1</sub><sup>2</sup> = V<sub>LL,before</sub><sup>2</sup> + V<sub>LL,after</sub><sup>2</sup> − 2 · V<sub>LL,before</sub> · V<sub>LL,after</sub> · cos(φ)
            </div>
      
            <div class="mono" style="margin-top: 10px;">
              cos(φ) =
              ( V<sub>LL,before</sub><sup>2</sup> + V<sub>LL,after</sub><sup>2</sup> − 3 · V<sub>L1,L1</sub><sup>2</sup> )
              / ( 2 · V<sub>LL,before</sub> · V<sub>LL,after</sub> )
            </div>
      
            <div class="mono" style="margin-top: 10px;">
              φ = arccos( cos(φ) )
            </div>
      
            <div class="muted" style="margin-top: 10px;">
              This is exactly the computation implemented by the tool.
            </div>
          </div>
        </div>
      </details>

  </main>

  <div id="site-footer"></div>

  <script>
    // Utilities
    function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }
    function isFiniteNumber(x) { return Number.isFinite(x) && !Number.isNaN(x); }

    function fmt(x, digits = 4) {
      if (!isFiniteNumber(x)) return "—";
      return Number(x).toLocaleString(undefined, { maximumFractionDigits: digits });
    }

    function show(el, on, text) {
      el.style.display = on ? "block" : "none";
      if (text !== undefined) el.textContent = text;
    }

    // Core math (field method)
    // From: 3*Vp^2 = Vb^2 + Va^2 - 2*Vb*Va*cos(phi)
    // => cos(phi) = (Vb^2 + Va^2 - 3*Vp^2) / (2*Vb*Va)
    function computePhi(vB, vA, vP) {
      const num = (vB * vB) + (vA * vA) - (3 * vP * vP);
      const den = 2 * vB * vA;
      const cosRaw = num / den;
      const cosClamped = clamp(cosRaw, -1, 1);
      const phiRad = Math.acos(cosClamped);
      return { cosRaw, cosClamped, phiRad };
    }

    // Feasibility bounds (cos(phi) in [-1,1])
    function feasibility(vB, vA, vP) {
      const left  = (vB - vA) * (vB - vA);
      const mid   = 3 * vP * vP;
      const right = (vB + vA) * (vB + vA);
      const ok = (mid >= left - 1e-9) && (mid <= right + 1e-9);
      return { ok, left, mid, right };
    }

    // DOM
    const vllBefore = document.getElementById("vllBefore");
    const vllAfter  = document.getElementById("vllAfter");
    const vl1l1     = document.getElementById("vl1l1");
    const unit      = document.getElementById("unit");

    const outMain   = document.getElementById("outMain");
    const outAlt    = document.getElementById("outAlt");
    const debug     = document.getElementById("debug");

    const msgWarn   = document.getElementById("msgWarn");
    const msgErr    = document.getElementById("msgErr");

    function resetOutput() {
      outMain.textContent = "—";
      outAlt.textContent = "";
      debug.textContent = "";
      show(msgWarn, false);
      show(msgErr, false);
    }

    document.getElementById("btnClear").addEventListener("click", () => {
      vllBefore.value = "";
      vllAfter.value  = "";
      vl1l1.value     = "";
      unit.value      = "deg";
      resetOutput();
    });

    document.getElementById("btnCalc").addEventListener("click", () => {
      show(msgWarn, false);
      show(msgErr, false);

      const vB = Number(vllBefore.value);
      const vA = Number(vllAfter.value);
      const vP = Number(vl1l1.value);

      // Validation
      if (!(vB > 0) || !(vA > 0) || !(vP >= 0)) {
        resetOutput();
        show(msgErr, true, "Please enter valid RMS voltages: VLL_before > 0, VLL_after > 0, and VL1-L1 ≥ 0.");
        return;
      }

      // Feasibility check
      const feas = feasibility(vB, vA, vP);
      if (!feas.ok) {
        show(msgWarn, true,
          "Warning: this input set is not physically consistent with any real phase shift. " +
          "Re-check measurements (wiring, meter range, steady-state)."
        );
      }

      // Compute
      const r = computePhi(vB, vA, vP);
      const phiDeg = r.phiRad * (180 / Math.PI);

      // Output formatting
      const mode = unit.value;
      if (mode === "deg") {
        outMain.textContent = `${fmt(phiDeg, 3)} °`;
        outAlt.textContent  = `(${fmt(r.phiRad, 6)} rad)`;
      } else if (mode === "rad") {
        outMain.textContent = `${fmt(r.phiRad, 6)} rad`;
        outAlt.textContent  = `(${fmt(phiDeg, 3)} °)`;
      } else {
        outMain.textContent = `${fmt(phiDeg, 3)} °`;
        outAlt.textContent  = `${fmt(r.phiRad, 6)} rad`;
      }

      // Debug (plain)
      debug.textContent =
        `Inputs: VLL_before=${fmt(vB, 6)} V, VLL_after=${fmt(vA, 6)} V, VL1-L1=${fmt(vP, 6)} V\n` +
        `cos(phi) raw=${fmt(r.cosRaw, 10)}; clamped=${fmt(r.cosClamped, 10)}\n` +
        `phi=${fmt(phiDeg, 6)} deg (${fmt(r.phiRad, 10)} rad)\n` +
        `Feasible=${feas.ok ? "YES" : "NO"}`;
    });

    // Init
    resetOutput();
  </script>
</body>
</html>
